How to Install Virtual Box on Rocky 9
-------------------------------------

References
----------
https://computingforgeeks.com/install-virtualbox-on-rocky-almalinux/


Procedure
---------
 1. Verify that virtualization is enabled on your computer
    unix> lscpu | grep -i virtualization

    You should see something like this:
      Virtualization:                  VT-x     (this is good)


 2. Verify that you are running 64-bit
    unix> lscpu

    Architecture:            x86_64
      CPU op-mode(s):        32-bit, 64-bit
      Address sizes:         39 bits physical, 48 bits virtual


 3. Add the Virtualbox Repository
    unix> sudo dnf install epel-release

 4. Install the required build tools:
    unix> sudo dnf install wget curl gcc make perl bzip2 dkms kernel-devel kernel-headers

 5. Compare the kernel-devel versions and the kernel versions:
    a. Get the version of the kernel header installed
       unix> sudo rpm -q kernel-devel

       I see this:
          kernel-devel-5.14.0-362.13.1.el9_3.x86_64


    b. Get the version of the kernel that is running
       unix> uname -r

       I see this:
          5.14.0-362.13.1.el9_3.x86_64


    c. If they do not match, then update the kernel
       unix> sudo dnf update
       unix> sudo reboot

  6. Add the repository for virtual box
     unix> sudo dnf config-manager --add-repo=https://download.virtualbox.org/virtualbox/rpm/el/virtualbox.repo

  7. List versions that are available for install
     unix> sudo dnf search virtualbox

  8. Install virtualbox 7
     unix> sudo dnf install VirtualBox-7.0

  9. Install the virtual box extension pack
     unix> VER=$(curl -s https://download.virtualbox.org/virtualbox/LATEST.TXT)
     unix> echo $VER
     7.1.2

     unix> cd /tmp
     unix> wget https://download.virtualbox.org/virtualbox/$VER/Oracle_VirtualBox_Extension_Pack-$VER.vbox-extpack
     -- You should have this file:  /tmp/Oracle_VirtualBox_Extension_Pack-7.1.12.vbox-extpack

     If this does not work, download it manually:
       Go to https://download.virtualbox.org/virtualbox/7.1.12/
       Look for Oracle_VirtualBox_Extension_Pack-7.1.12.vbox-extpack


 10. Build the kernel modules
     unix> sudo /sbin/vboxconfig


 11. Once downloaded, navigate to the location of the file and install it with the command:
     unix> cd /tmp
     unix> sudo VBoxManage extpack install Oracle_VirtualBox_Extension_Pack-7.1.12.vbox-extpack

	 Do you agree to these license terms and conditions (y/n)?   Y


 12. Verify that the VirtualBox Extension Pack is installed
     unix> vboxmanage list extpacks

     You should see this:
		Extension Packs: 1
		Pack no. 0:   Oracle VM VirtualBox Extension Pack
		Version:        7.0.14
		Revision:       161095
		Edition:
		Description:    Oracle Cloud Infrastructure integration, Host Webcam, VirtualBox RDP, PXE ROM, Disk Encryption, NVMe, full VM encryption.
		VRDE Module:    VBoxVRDP
		Crypto Module:  VBoxPuelCrypto
		Usable:         true


 13. Add your unix account to the vboxusers group
     NOTE:  This step was *NOT* needed in virtual 7.1
     a. Add your unix account to the vboxusers group
        unix> sudo usermod -a -G vboxusers <USERNAME>

     b. Reboot
        unix> sudo reboot

 14. Disable the kernel module responsible for KVM (Kernel-based Virtual Machine) as it seems to conflict with VirtualBox.
     a. Verify that the kvm module is loaded
        unix> lsmod | grep kvm
        kvm_intel             446464  0                   # Shows the the KVM module is loaded
        kvm                  1404928  1 kvm_intel         # Shows the the KVM module is loaded

     b. Disable the KVM module  (until next reboot)
        unix> sudo modprobe -r kvm_intel    # Disable kvm for intel processors

     c. Verify that the kvm module is not loaded
        unix> lsmod | grep kvm
        -- Should show nothing

     d. Permanently disable KVM module on bootup
        unix> sudo vi /etc/modprobe.d/kvm.conf
        blacklist kvm_intel
        blacklist kvm


 15. Startup virtualbox
     unix> virtualbox



Part 2:  Install Windows VM on Rocky 9
--------------------------------------
 1. Download the Windows 11 ISO   (upto 6 GB download)
    a. Open a browser
    b. Go to https://www.microsoft.com/en-us/software-download/windows11
       1) In the Download Windows 11 Disk Image (ISO) /  "Select Edition" dropdown, choose "Windows 11"
          Press "Confirm"

       2) In the "Select Product language", choose "English"
          Press "Confirm"

       3) Click on "64-bit Download"
          -- You will be prompted to save your ISO
          -- Save the Win11_24H2_English_x64.iso to your Downloads/ directory


 2. Use VirtualBox to create a Windows 11 virtual machine
    a. Startup VirtualBox Manager
       unix> virtualbox

    b. In the VirtualBox manager
       1) Press "New"  (or Pull Machine -> New)
       2) In the "Name and operating system" screen
          Name:       Win11_vm
          Folder:     /home/adam/VirtualBox VMs
          ISO Image:  Browse to your ~/Downloads/Win11_24H2_English_x64.iso

          Edition:    Windows 11 Pro
          Type:       Microsoft Windows
          Version:    Windows 11 (64-bit)

          Check "Skip Unattended Installation"



       3) In the "Hardware" section
          Base Memory:     12288 MB  (or 12 GB)
          Processors:      2
          Uncheck   "Enable EFI"


       3) In the "Hard Disk" section
          Choose "Create a virtual hard disk now"
          Set the size to 80 GB                     NOTE:  When installing Windows 10 Professional on a 50 GB drive, there was 30 GB left
          Press "Next"
          Press "Finish"



 9. Install Windows 11 within VirtualBox
    a. Startup your Windows 11 VM (for the first time)
       Right-click on Win11_vm -> Start -> Normal Start

    b. When it says, "Press any key to boot"
       Press the <Space bar>

    c. In the First screen
       Language to install:  English
       Time and currency:    English
       Press "Next"

    d. In the Select keyboard settings
       Keyboard or input method:  US
       Press "next"

    e. In the Select setup option
       Choose "Install Windows 11"
       Check  "I agree everything will be deleted"
       Press "Next"

       press "Install now"

    f. In the "Product key" screen
       Press "I don't have a product key"

    g. In the "Select Image" screen
       Choose "Windows 11 Pro"
       Press "Next"

    h. In "Available notices and license terms" screen
       Press "Accept"

    i. In the "Select location to install Windows 11"
       NOTE:  The size of the disk is the maximum size you specified above
       Select Drive 0 (80 GB of unallocated space)
       Press "Next"

    j. In the "Ready to install"
       Press "Install"

         W A I T      5       M I N U T E S     (for the installer to finish)


    k. In the "Is this the right country or region?"
       Select "United States"
       Press "Yes"

    l. In the "Is this the right keyboard layout?
       Select "US"
       Press "Yes"

    m. In the "Want to add a second keyboard layout?"
       Press "Skip"

    n. In the "Let's name your device"
       Name:  win11_vm
       press "Next"

    o. In the "How would you like to set up?"
       Select "Set up for personal use"
       Press "Next"

          W A I T      1 0       M I N U T E S     (for the windows to download & apply updates)

    p. In the "Sign in" page, press Shift-F10 (to open a command prompt)
       Terminal> start ms-cxh:localonly

    q. In the "Create a user for this pc:
       User Name:  john.smith
       Password:   secret
       Verify PW:  secret:
       Enter your secret questions
       Press "Next"

         W A I T      5       M I N U T E S     (for windows to create the profile)

    r. In the "Choose Privacy settings for your device"
       Turn them all Off
       Press "Accept"

       -- Now you are running Windows 11


    s. Set the timezone to Eastern
        Right-click on the clock (in the bottom right corner) -> Adjust Date Time
        Change the timezone to UTC-0:500 Eastern Time (US & Canada)

    t. Shutdown Windows 11
       Right-click on the windows icon -> Shut Down or sign out -> Shutdown



Part 3:  Install Guest Options (so you can have shared folders and shared clipboard)
------------------------------------------------------------------------------------
 1. Install Guest Options
    a. Verify that you have the Guest Additions ISO
       NOTE: The Guest Options iso should be located here:
         /usr/share/virtualbox/VBoxGuestAdditions.iso

     If you do not see the iso image there, then
       1) Download the Guest Options for Virtual Box 7.0.1.4
          Go to http://download.virtualbox.org/virtualbox/7.0.14/VBoxGuestAdditions_7.0.14.iso
       2) Save it to C:\Program Files\Oracle\VirtualBox\

    b. Configure your VM so that the guess options ISO is in the virtual CD-ROM
       1) In Virtual Box / Right-click on Win11_vm -> Settings
       2) Select Storage
          -- Verify that you see VBoxGuessAdditions.iso

    c. Power Up your Windows 11 VM

    d. Keep Pressing Right-Ctrl C  [until you see a menubar at top]
       -- You should see a menubar with
            File   Machine  View  Input Devices Help

    e. Load the Guest Image ISO
       Pull Devices / Insert Guest Image ISO
       NOTE:  You should see the CD appear on the desktop

    f. In your Win VM, you should see CD Drive D:\ that has your guest additions
       -- Double-click on VBoxWindowsAdditions.exe
       -- press OK

       1) Do you want to allow this app to make changes to your device?
          Press Yes

       2) In the Welcome to Oracle VM Virtual Box Guest Additions 7.0.14 Setup
          Press "Next"

       3) In the Choose Install Location
          Use the defaults
          Press "Next"

       4) In the "Choose Components"
          Press "Install"

       5) In the "Completing Oracle VM Virtualbox Guest Additions 7.0.14 Setup"
          Select Reboot now
          Press "Finish"


    g. Eject the Guest Image ISO from your optical drive
       Pull  Device -> Optical Drive -> Remove Disc from virtual drive

    h. Shutdown the windows VM
       Right-click on the windows icon -> Shut Down or sign out -> Shutdown





 2. Enable copy+paste between host and guess OS          (REQUIRES Guest Additions to be installed)
    a. Power Down your Windows VM
    b. Right-click on your VM -> Settings
    c. Select General [on the left]
    d. Click on the "Advanced" tab
       Shared Clipboard:  Bidirectional
       press OK

    e. Power Up your Windows VM
       Right-click on Win11_vm -> Start -> Normal Start

    f. In your Rocky Linux, copy some text
       In your Windows, open up notepad
       attempt to paste it



Part 4:  Configure ITunes and Mount a Music directory
-----------------------------------------------------
 1. Mount the /home/adam/Music to your c:\music on your VM          (REQUIRES Guest Additions to be installed)
     a. Power Down your Windows VM
     b. Right-click on your VM -> Settings
     c. Click on "Shared Folders" [on the left]
     d. Right-click on "Machine Folders" -> Add Shared Folder
     e. In the "Add Share"
          Folder Path:   /home/adam/Music
          Folder name:   Music
          Mount point:   c:\users\john.smith\music
          Uncheck Read-Only
          Check   Auto-mount
          Press OK
          Press OK

          WARNING:  Choose your windows directory as a directory under c:\users\my_windows_account
                    as windows does not like mounting a directory directly under c:\
                    So....
                            c:\vault                             [bad windows path]
                            c:\users\my_windows_account\vault    [good windows path]

    e. Power Up your Windows VM
       Right-click on Win11_vm -> Start -> Normal Start

    f. In your windows, look for a Z:\ drive
       -- This local Z:\ drive should correspond to your /home/adam/Music



 2. Install iTunes  (from inside the windows 10 VM)
    a. Download it from here:
       https://support.apple.com/en-us/HT210384

    b. Click on Download iTunes 12.10.11 for Windows 10 (64-bit)
       -- Save it your Downloads/ windows directory

    c. Run the iTunes64Setup.exe

    d. Use the default settings


 3. Startup iTunes
    a. Enable the menubar
    b. Pull Help -> Run Diagnostics
    c. Select Network connectivity tests only
       -- You should see "All tests passed"

    d. Pull Edit -> Preferences
    e. Click on Advanced
    f. Select your Device folder as z:\iTunesMusic\

    g. Drag and drop the directories in z:\iTunesMusic\ to the Library
       -- And they should appear in iTunes

 4. Download Art Work
    a. Startup iTunes
    b. Sign-in to iTunes
    c. Pull File -> Library -> Get Album Artwork


 5. Sync the iPod in the windows VM
    a. Connect your ipod to your Rocky Linux 9
    b. Power down your win10 VM
    c. Right-click on Win11_vm -> Settings
    d. Select USB  [on the left]
    e. Under  "USB Device Filters", press the "Add USB Filter" icon
    f. Check off Select Apple Inc. Ipod [0001]
    g. Press OK
    h. Startup your win10 VM
    i. In win10, click on the browser icon
    j. Select "This PC"
    	-- Verify that you see your ipod
    k. Startup iTunes
        -- It should now be able to sync with your ipod

    l. Click on Library -> Songs
    m. Pull Edit -> Select All
    n. Drag and drop all songs to your iPod
       -- That should sync it

