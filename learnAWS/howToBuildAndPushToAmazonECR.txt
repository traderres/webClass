How to Build and Push Container to Amazon ECR
---------------------------------------------
It would be great if developers could build and push docker images to an Amazon ECR (without having docker installed)


References
----------
https://tech.asimio.net/2018/09/05/Pushing-Spring-Boot-2-Docker-images-to-Amazon-ECR.html



Procedure for Windows  (does not require docker)
------------------------------------------------
 1. Install AWS Cli for windows
    a. Install the AWS CLI
       CMD> msiexec.exe /i https://awscli.amazonaws.com/AWSCLIV2.msi

    b. Close the existing terminal

    c. Verify the AWS CLI is installed
       CMD> aws --version

       You should see this:
          aws-cli/2.11.23 Python/3.11.3 Windows/10 exe/AMD64 prompt/off


 2. Setup AWS Credentials
    CMD> aws configure

	AWS Access Key ID [****************E7WC]:      AKIAXVSK767676TMTRI4E7WC
	AWS Secret Access Key [****************1kLw]:  abcdef+A1AOJCj/w3BB5V21kLw
	Default region name [us-gov-west-1]:
	Default output format [json]:


 3. Get the password and store it in a variable
    NOTE:  The password string is longer than 1024 characters
           Windows will not let you set a variable that is more than 1024 chars
           Fortunately, the open-source SetEnv program will let do this

    a. Install SetEnv
       Go to https://www.codeproject.com/Articles/12153/SetEnv

    b. Download the zip file  (which contains a single-file installer)

    c. Open the zip file ane extract the installer

    d. Run the installer:  SetEnv_Setup.exe
       -- Use the default settings

    e. Get the long password
       CMD> aws ecr get-login-password --region us-gov-west-1

    f. Copy the password to your clipboard by highlighting it and pressing Control-C

    g. Use the setenv command to set the long text into a variable called PASSWORD
       CMD> setenv -ua PASSWORD "<PASTE IN LONG PASSWORD BETWEEN QUOTES>"

    h. Close that terminal

    i. open a NEW terminal

    j. Verify the password exists
       CMD> echo %PASSWORD%


 4. Build and push (using the password)
    CMD> mvn  -Djib.console=plain  -Djib.to.auth.username=AWS  -Djib.to.auth.password=%PASSWORD% clean package -Pprod -PbuildImageAndPush





Procedure for Unix  (does not require docker)
---------------------------------------------
 1. Install AWS Cli for windows
    a. Install the AWS CLI
       unix> curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
       unix> unzip awscliv2.zip
       unix> sudo ./aws/install

    c. Verify the AWS CLI is installed
       unix> aws --version

       You should see this:
          aws-cli/2.11.23 Python/3.11.3 Windows/10 exe/AMD64 prompt/off


 2. Setup AWS Credentials
    unix> aws configure

	AWS Access Key ID [****************E7WC]:      AKIAXVSK767676TMTRI4E7WC
	AWS Secret Access Key [****************1kLw]:  abcdef+A1AOJCj/w3BB5V21kLw
	Default region name [us-gov-west-1]:
	Default output format [json]:


 3. Get the password and store it in a variable
    unix> export PASSWORD=`aws ecr get-login-password --region us-gov-west-1`


 4. Build and push (using the password)
    unix> mvn clean package -Djib.to.auth.username=AWS -Djib.to.auth.password=$PASSWORD -Pprod -PbuildImageAndPush




Procedure (requires docker)
---------------------------
 1. Get the access key and secret access key from AWS
    Access key ID:      AKIAXVSK767676TMTRI4E7WC
    Secret access key:  abcdef+A1AOJCj/w3BB5V21kLw
    Region:             us-gov-west-1


 3. Setup AWS Credentials
    unix> aws configure

	AWS Access Key ID [****************E7WC]:      AKIAXVSK767676TMTRI4E7WC
	AWS Secret Access Key [****************1kLw]:  abcdef+A1AOJCj/w3BB5V21kLw
	Default region name [us-gov-west-1]:
	Default output format [json]:


 4. Login to AWS
    unix> aws ecr get-login-password --region us-gov-west-1 | docker login --username AWS --password-stdin 527362555097.dkr.ecr.us-gov-west-1.amazonaws.com


 5. Verify that the pom.xml has the correct tag name
    a. Edit backend/pom.xml
    b. Verify that the "buildImageAndPush" profile has the correct <image><to> tag

         <to>
              <image>527362555097.dkr.ecr.us-gov-west-1.amazonaws.com/nccs:${project.artifactId}-${project.version}</image>
         </to>


        Here is a complete maven profile

				<profile>
					  <id>buildImageAndPush</id>

					  <!-- When running this profile, do *NOT* include the src/main/resources/application.yaml in the build -->
					  <build>
						<resources>
						  <resource>
							<filtering>false</filtering>
							<directory>src/main/resources</directory>
							<excludes>
							  <exclude>application.yaml</exclude>
							</excludes>
						  </resource>
						</resources>

						<plugins>
						  <plugin>
							<!-- Use the jib-maven-plugin to build the container and push it up to a registry [without having to install Docker] -->
							<groupId>com.google.cloud.tools</groupId>
							<artifactId>jib-maven-plugin</artifactId>
							<version>3.3.1</version>

							<executions>
							  <execution>
								<phase>package</phase>
								<goals>
								  <!-- Possible goals are build and dockerBuild   -->
								  <!--   The "build"       goal does not require docker / build the image and push it to a repo                 -->
								  <!--   The "dockerBuild" goal requires docker         / build the image and push to the local daemon daemon   -->
								  <goal>build</goal>
								</goals>
							  </execution>
							</executions>

							<configuration>
							  <from>
								<!-- Define the source image that will be executed            -->
								<!-- See https://hub.docker.com/_/eclipse-temurin/tags        -->

								<!-- This source image runs linux with JDK 17.07 -->
								<image>eclipse-temurin:17.0.7_7-jdk@sha256:9dd6a19e4819b066aa2bd8e54d5988a49cca29736fe5447cb0a57daa975f8935</image>
							  </from>

							  <to>
								<image>527362555097.dkr.ecr.us-gov-west-1.amazonaws.com/nccs:${project.artifactId}-${project.version}</image>
							  </to>


							  <extraDirectories>
								<paths>
								  <path>
									<!-- Copies everything from 'src/main/image_resources' into '/sync-service-/src/main/image_resources' on the container. -->
									<from>src/main/image_resources</from>
									<into>/backend/src/main/image_resources</into>
								  </path>
								</paths>
							  </extraDirectories>

							  <container>
								<jvmFlags>
								  <!-- When starting the container, tell Java where to find the application.yaml -->
								  <jvmFlag> -Dspring.config.location=/backend/src/main/image_resources/application.yaml</jvmFlag>
								</jvmFlags>
							  </container>

							</configuration>

						  </plugin>
						</plugins>
					  </build>
					</profile>


 5. Now build and push
    unix> mvn clean package -Pprod -PbuildImageAndPush



