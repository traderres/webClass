How to Sign Commits with a CAC (on Windows 10)
----------------------------------------------
Problem:  My Gitlab environment requires me to sign commits with a CAC

Assumptions
 A) You have git for windows installed


References
----------
https://p1docs.dso.mil/docs/party-bus/mission-devops-mdo/how-tos/gitlab/commit-signing-with-cac/



Part 1 / Download & Install Gpg4win
-----------------------------------
 1. Download gpg4win v4.3.1
    a. Go to https://www.gpg4win.org/download.html
    b. Press the Download Icon
    c. Press $0
    d. Press "USD"
    e. Press "Download"
       *OR*
       Go to https://files.gpg4win.org/gpg4win-4.3.1.exe

    f. Save gpg4win-4.3.1.exe to your Downloads/ directory


 2. Install gpg4win
    a. Run gpg4win-4.3.1.exe
    b. For the "Installer Language"
       -- Use the default of "English"
       -- Press OK
	c. For the "Welcome" page
	   -- Press "Next"
	d. For the "Choose Components" page
	   -- Use the defaults
	   -- Press "Next"
	e. For the "Install Location" page
	   -- Destination Folder:  c:\tools\gpg4win           <<--- THIS IS NOT THE DEFAULT SETTING / PLEASE USE THIS!!!!!
	   -- Press "Install"
    f. In the "Installation Complete" page
       -- Press "Next"
    g. In the "Completing Gpg4win Setup"
       -- Uncheck "Run Kleopatra"
       -- Press "Finish"


 3. Verify gpg is installed
    a. Open a new terminal

    b. In the terminal
       DOS> gpg --version

	   You should see something like this:
		   gpg (GnuPG) 2.4.5
		   libgcrypt 1.10.3
		   Copyright (C) 2024 g10 Code GmbH
		   License GNU GPL-3.0-or-later <https://gnu.org/licenses/gpl.html>
		   This is free software: you are free to change and redistribute it.
		   There is NO WARRANTY, to the extent permitted by law.

		   Home: C:\Users\johnsmith\AppData\Roaming\gnupg
		   Supported algorithms:
		   Pubkey: RSA, ELG, DSA, ECDH, ECDSA, EDDSA
		   Cipher: IDEA, 3DES, CAST5, BLOWFISH, AES, AES192, AES256, TWOFISH,
				   CAMELLIA128, CAMELLIA192, CAMELLIA256
		   Hash: SHA1, RIPEMD160, SHA256, SHA384, SHA512, SHA224
		   Compression: Uncompressed, ZIP, ZLIB, BZIP2




Part 2 / Download & Install smimesign
-------------------------------------
 1. Go to https://github.com/github/smimesign/releases/tag/v0.2.0-rc1

 2. Download smimesign-windows-v0.2.0-rc1.exe
    -- Save it to your Downloads/ directory

 3. Run smimesign-windows-v0.2.0-rc1.exe
    a. Press "Install anyway"

    b. In the "License Agreement" page
       -- Press "I accept the agreement"
       -- Press "Next"

    c. In the "Select Destination Location"
       -- Set it to c:\tools\smimesign                   <<----- THIS IS NOT THE DEFAULT SETTING!!!!!
       -- Press "Next"

    d. In the "Completing the setup"
       -- Press "Finish"


 4. Create an environment variable called "smimesign" for your account
    a. In windows, search for edit environment
    b. Select "Edit environment variables for your account"
    c. In the top, press "New..."
       Variable name:      smimesign
       Variable value:     c:\tools\smimesign
    d. Press "OK" a few times


 5. Verify that it's in your path
    a. Open a new terminal
    b. Run these commands:
       terminal> smimesign --version

       You should see this:
         v0.2.0-rc1


 6. Get the serial number of your CAC
    a. Insert your CAC into your card reader

    b. List the keys
       terminal> smimesign --list-keys


		-- The ID of the important serial number should match with the thumbprint id of the





Part 3 / Clone the IL5 Project
------------------------------
 1. Turn on appgate

 2. Generate an access token
    a. Sign in to GitLab
       -- Go to https://code.il5.dso.mil/
    b. On the left sidebar, select your avatar (to go to User Settings)
    c. Select Edit profile.
    d. Select Access tokens
    e. Press "Add new token"
    f. In the "Add a personal access token" page
       -- Token Name:              My silly access token
       -- Expiration Date:         <Set it to 1 year from yesterday>
       -- Check "read_repository"
       -- Check "write_repository"
       -- Press "Create personal access token"
    g. Copy the access token to your clipboard / copy & paste this token it into a temporary text file


 3. Get your userid
    a. On the left sidebar, select your avatar (to go to User Settings)
    b. Select Edit profile.
       -- Scroll Down
       -- You should see your userid / copy & paste it into a temporary text file


 4. Get the clone url
    a. Go to the project you wish to clone -- e.g., Get the clone url
       Go to https://code.il5.dso.mil/platform-one/products/DCSA/ni2/core-admin
    b. Press "Code"
    c. Copy the "Clone with HTTPS" and paste this into a temporary text file


 5. Assemble the git clone command
    -- Assemble the pieces so your git clone command

                                Userid    Access Token
                                  |         |
                                  V         V
              git clone https://USERID:ACCESS_TOKEN@CLONE_URL
                                                       ^
                                                       |
                                                       |
                                                     If the url is https://www.stuff.com/my-site/stuff/stuff.git
                                                     then the CLONE_URL is www.stuff.com/my-site/stuff/stuff.git

  6. Run the git clone command using your access token
     a. Open a terminal
     b. In the terminal run these commands
        terminal> cd c:\tools\projects    # or whereever your projects are stored
        terminal> git clone https://USERID:ACCESS_TOKEN@CLONE_URL



Part 4 / Download & Install Certificates in your CAC's Certificate Chain
------------------------------------------------------------------------
 1. Insert your CAC into your card reader

 2. Open the Certificate Manager
    a. In Windows, search for "manage user certificates"
    b. Run "Manage User Certificates"

 3. In the Certificate Manager App, run these steps:
    a. Expand Personal -> Certificates
    b. Make the window wider -- so you can see the columns
    c. Sort by "Expiration Date"
       -- You should see your 3 certificates (from your CAC)
       -- Of your 3 certificates (from your CAC), look for the CAC that has the expiration date in the future -- probably April 2025

    d. Double-click on your CAC cert that has an "Intended Purpose" of "Secure Email, Document Signing"

	e. Click on "Certificate Path"
		-- You should see something like this
			CertPath Bridge CA - G3
				Federal Bridge CA G4
					DoD Interoperability Root CA 2
						DoD Root CA 6
							DOD EMAIL CA-72
								YOUR CAC CARD



 4. From the Certificate Manager, install the certs that make up your CAC's chain
 	a. Install the certificate:   YOUR CAC CARD
 	   1) Double-click on YOUR CAC CARD
 	   2) Press "Details"
 	   3) Press "Install Certificate..."
 	   4) Use the defaults
 	      -- Press Next
 	      -- Press Next
 	      -- Press Finish

	b. Install this certificate:  DOD EMAIL CA-72
	   1) Double-click on "DOD EMAIL CA-72"
	   2) Press "Details"
	   3) Press "Install Certificate..."
	   4) Use the defaults
	      -- Press Next
	      -- Press Next
	      -- Press Finish

	c. Install this certificate:  DoD Root CA 6
	   1) Double-click on "DoD Root CA 6"
	   2) Press "Details"
	   3) Press "Install Certificate..."
	   4) Use the defaults
	      -- Press Next
	      -- Press Next
	      -- Press Finish

	d. Install this certificate:  DoD Interoperability Root CA 2
	   1) Double-click on "DoD Interoperability Root CA 2"
	   2) Press "Details"
	   3) Press "Install Certificate..."
	   4) Use the defaults
	      -- Press Next
	      -- Press Next
	      -- Press Finish

	e. Install this certificate:  Federal Bridge CA G4
	   1) Double-click on "Federal Bridge CA G4"
	   2) Press "Details"
	   3) Press "Install Certificate..."
	   4) Use the defaults
	      -- Press Next
	      -- Press Next
	      -- Press Finish

	f. Install this certificate:  CertPath Bridge CA - G3
	   1) Double-click on "CertPath Bridge CA - G3"
	   2) Press "Details"
	   3) Press "Install Certificate..."
	   4) Use the defaults
	      -- Press Next
	      -- Press Next
	      -- Press Finish

 5. From the Certificate Manager, Download certs that make up your CAC's chain
	a. Download your CAC Cert to c:\temp\cac.er
	   1) Double-click on YOUR CAC CARD
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\cac           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK

	b. Download the 1st parent to c:\temp\parent1.cer:  DOD EMAIL CA-72
	   1) Double-Click on "DOD EMAIL CA-72"
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\parent1           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK

	c. Download the 1st parent to c:\temp\parent2.cer:   DoD Root CA 6
	   1) Double-Click on "DoD Root CA 6"
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\parent2           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK

	d. Download the 1st parent to c:\temp\parent3.cer:   DoD Interoperability Root CA 2
	   1) Double-Click on "DoD Interoperability Root CA 2"
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\parent3           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK

	e. Download the 1st parent to c:\temp\parent4.cer:   Federal Bridge CA G4
	   1) Double-Click on "Federal Bridge CA G4"
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\parent4           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK

	f. Download the 1st parent to c:\temp\parent5.cer:   CertPath Bridge CA - G3
	   1) Double-Click on "CertPath Bridge CA - G3"
	   2) Press "Details"
	   3) Press "Copy to File..."
	      a) In the Welcome Page, press Next
	      b) In the Select Format, use the defaults DER encoded binary, press "Next"
	      c) Filename:   c:\temp\parent5           # Windows will add the .cer extension to it for you
	      d) Press Finish
	      e) Press OK



 6. Open a terminal and import these cer files
    terminal> cd c:\temp
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import parent1.cer
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import parent2.cer
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import parent3.cer
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import parent4.cer
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import parent5.cer
    terminal> gpgsm --disable-crl-check --disable-trusted-cert-crl-check --import cac.cer

 7.	Restart the GPG agent
    terminal> gpgconf --kill all


 8. Startup Kleopatra
    -- It will say "Loading certificate cache"

    a. Do you ultimately trust DoD Root?
       -- Press "Yes"

    b. Please verify that the certificate identified as DoD Root Ca..... is correct
       -- Press "Correct"

    c. Do you ultimately trust DoD Root CA..."
       -- Press "Yes"

	d. Please verify that the certified identified as DoD Root CA...is correct
	   -- Press "Correct"

    e. Close it







Part 5 / Configure Git to use your signing key/email address/full name
----------------------------------------------------------------------
 1. Verify that gpgsm can see the secret key for your CAC
	terminal> gpgsm --list-secret-keys

		You should see this:
					   ID: 0x7BC333D5
					  S/N: 087594
					(dec): 554388
				   Issuer: /CN=DOD EMAIL CA-72/OU=PKI/OU=DoD/O=U.S. Government/C=US
				  Subject: /CN=SMITH.JOHN.1234567890/OU=CONTRACTOR/OU=PKI/OU=DoD/O=U.S. Government/C=US
					  aka: john.smith.ctr@mail.mil
				 validity: 2024-08-02 00:00:00 through 2025-04-17 23:59:59
				 key type: rsa2048
				key usage: digitalSignature nonRepudiation
			ext key usage: emailProtection (suggested), ms-documentSigning (suggested)
				 policies: 2.16.840.1.101.2.1.11.42:N:
				 sha1 fpr: 16:B2:9B:06:C3:82:86:81:E7:E8:95:F1:9C:EB:E3:8B:7B:C3:33:D5
				 sha2 fpr: A1:F0:92:13:35:E0:BD:92:56:38:91:3B:AE:C2:1B:C3:3B:19:3C:3F:13:AE:B3:41:59:63:6B:C5:11:4E:33:5A
				 card s/n: 123456789123456789123456


 2. Get the ID for your CAC and set it in Git for YOUR project
 	a. Copy the Thumbprint ID of your CAC
 	   1) In Windows, search for manager user certificates
 	   2) Run "Manage User Certificates"
 	   3) Open Personal -> Certificates
 	   4) Make the window wider
 	   5) Sort by expiration date
 	      -- So, the 3 certs for your CAC are next to each other
 	   6) Double click on your CAC cert (it has an expiration date in the future *AND* intended purpose is "Secure Email, Document Signing"
 	   7) Click on this tab:  "Details"
 	   8) Single-click on thumbprint
 	   9) Copy the value (from the bottom of the popup)
 	  10) Press OK

    b. Set the signing key for YOUR project
       terminal> cd c:\tools\projects\my-project
   	   terminal> git config --local user.signingkey <THE THUMBRPRINT ID>
	   terminal> git config --local gpg.program c:\tools\smimesign\smimesign.exe
	   terminal> git config --local gpg.format x509
	   terminal> git config --local commit.gpgsign true

 2. Run this command to set your user.email
    terminal> git config --local user.email john.smith@zztop.com

 3. Run this command to set your git name
    NOTE:  Use double quotes  (not apostrophes!!!)
    terminal> git config --local user.name "John Smith"

 4. Verify that these values are set
    terminal> git config --local --list | sort

    You should see:
      commit.gpgsign=true
      ...
      gpg.format=x509
      gpg.program=c:\tools\smimesign\smimesign.exe
      ....
      user.email=john.smith@zztop.com
      user.name=John Smith
      user.signingkey=123456789123456789



Part 6 / Try your first git commit signing w/cac from command-line
------------------------------------------------------------------
 1. Open a terminal

 2. Run these commands:
    terminal> cd c:\tools\projects\bogus
    terminal> git checkout -b YOUR_INITIALS/test

 3. Make a change to the README.med
    terminal> echo "hi" >> README.md

 4. Attempt to commit the change
    terminal> git commit -a -m "Test Commit"

    -- You should be prompted to enter your CAC pin

 5. Attempt to push the commit up
    terminal> git push --set-upstream origin YOUR_INITIALS/test

    -- Verify that you see no errors!!!!



 6. Look at the signature in the log
    terminal> git log --show-signature

    You should see
    	smimesign:  Signature made using certificate ID.....
    	smimesign:  Good signature from "CN=......"
    	Author		<Your full name> <Your email address>
    	Date:		<Today's Date>

    		Test Commit



Part 7 / Try your first git commit signing w/cac from intelliJ
--------------------------------------------------------------
 1. Startup IntelliJ

 2. Open the above project

 3. Verify that the GPG key is configured for you in IntelliJ
    a. Pull File -> Settings -> Version Control -> Git
    b. Press "Configure GPG Key"
       -- It should be checked

 4. Make a change in IntelliJ to the README.md

 5. Do a commit and push
    -- It will prompt you for your PIN
	-- Verify that the push works

